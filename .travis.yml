sudo: false

language: rust
cache: cargo
matrix:
  fast_finish: true
  include:
  - env:
      - NAME="stable"
      # Link dead code to improve code coverage.
      - RUSTFLAGS="-C link-dead-code"
      - KCOV_RELEASE=v34
    rust: stable
    addons:
    apt:
      packages:
        - libcurl4-openssl-dev
        - libelf-dev
        - libdw-dev
        - cmake
        - gcc
        - binutils-dev
        - libiberty-dev
    after_success: |
       wget https://github.com/SimonKagstrom/kcov/archive/$KCOV_RELEASE.tar.gz &&
       tar xzf $KCOV_RELEASE.tar.gz &&
       cd kcov-$KCOV_RELEASE &&
       mkdir build &&
       cd build &&
       cmake .. &&
       make &&
       make install DESTDIR=../../kcov-build &&
       cd ../.. &&
       rm -rf kcov-$KCOV_RELEASE &&
       for file in target/debug/hashring-*[^\.d]; do mkdir -p "target/cov/$(basename $file)"; ./kcov-build/usr/local/bin/kcov --exclude-pattern=/.cargo,/usr/lib --verify "target/cov/$(basename $file)" "$file"; done &&
       bash <(curl -s https://codecov.io/bash) &&
       echo "Uploaded code coverage"
  - env: NAME="beta"
    rust: beta
  - env: NAME="nightly"
    rust: nightly
  - env: NAME="format"
    rust: nightly
    install:
    - rustup component add rustfmt-preview
    script:
    - cargo fmt -- --write-mode=check
  - env: NAME="lint"
    rust: nightly
    install:
    - cargo install clippy || echo clippy already installed
    script:
    - cargo clippy
